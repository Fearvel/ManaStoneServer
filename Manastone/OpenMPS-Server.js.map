{"version":3,"file":"OpenMPS-Server.js","sourceRoot":"","sources":["OpenMPS-Server.ts"],"names":[],"mappings":"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","sourcesContent":["import * as fs from 'fs';\r\n// @ts-ignore\r\nimport * as config from './config.json';\r\nimport * as https from 'https';\r\nimport * as express from 'express';\r\nimport * as MysqlConnector from './MySQLConnector';\r\n\r\nlet mysqlConnectionManager = new MysqlConnector.sql.MySQLConnector;\r\nlet app = express();\r\nlet options = {\r\n    key: fs.readFileSync(config.CertPath.key),\r\n    cert: fs.readFileSync(config.CertPath.cert)\r\n};\r\nlet server = https.createServer(options, app);\r\nlet io = require('socket.io')(server);\r\n\r\nconst Version = \"0.9.1.0\";\r\n\r\n\r\n/**\r\n * Socket.io Server Handler\r\n * Reacts on incoming Connections\r\n */\r\nio.on('connection', (socket) => {\r\n    //   socket.emit('info', Version);\r\n    mysqlConnectionManager.insertServerLog(socket.id.toString(), \" Connection Opened\");\r\n\r\n\r\n    /**\r\n     * Handles incoming OidRequest\r\n     * Sends the latest Oid Table, if the token is in the Database\r\n     */\r\n    socket.on('OidRequest', (token) => {\r\n        try {\r\n            mysqlConnectionManager.insertServerLog(socket.id.toString(), \"New OidRequest from \"\r\n                + socket.ipAddress.toString());\r\n            mysqlConnectionManager.getOidTable().then(row => {\r\n                socket.emit(\"OidOffer\", JSON.stringify(row));\r\n            });\r\n        } catch (e) {\r\n            console.log(e);\r\n        }\r\n    });\r\n\r\n    /**\r\n     * Handles incoming SendData\r\n     * Inserts a OidDataSet into the Database\r\n     */\r\n    socket.on('SendData', (data) => {\r\n        try {\r\n            mysqlConnectionManager.insertServerLog(socket.id.toString(), \"New Data from \"\r\n                + socket.ipAddress.toString());\r\n            var a = JSON.parse(data)\r\n            mysqlConnectionManager.insertOidSet(a);\r\n            sendSimpleResult(socket, true);\r\n        } catch (e) {\r\n            sendSimpleResult(socket, false);\r\n        }\r\n\r\n    });\r\n\r\n    /**\r\n     * Handles incoming OidVersionRequest\r\n     * Sends the latest Oid Version\r\n     */\r\n    socket.on('OidVersionRequest', () => {\r\n        mysqlConnectionManager.getOidVersion().then(row => {\r\n                mysqlConnectionManager.insertServerLog(socket.id.toString(), \"New OidVersionRequest from \"\r\n                    + socket.ipAddress.toString());\r\n                socket.emit(\"OidVersion\", JSON.stringify(row[0]));\r\n            }\r\n        );\r\n    });\r\n\r\n    /**\r\n     * Handles incoming MPSVersionRequest\r\n     * Sends the latest MPS Version\r\n     */\r\n    socket.on('MPSVersionRequest', () => {\r\n        mysqlConnectionManager.getMPSVersion().then(row => {\r\n                mysqlConnectionManager.insertServerLog(socket.id.toString(), \"New MPSVersionRequest from \"\r\n                    + socket.ipAddress.toString());\r\n                socket.emit(\"MPSVersion\", JSON.stringify(row[0]));\r\n            }\r\n        );\r\n    });\r\n\r\n    /**\r\n     * Disconnect event\r\n     * Inserts Connection closed message into the Serverlog Table\r\n     */\r\n    socket.on('disconnect', () => {\r\n        mysqlConnectionManager.insertServerLog(socket.id.toString(), \"Connection Closed\");\r\n    });\r\n});\r\n\r\n/**\r\n * Sends a SimpleResult\r\n * @param socket\r\n * @param res\r\n * @constructor\r\n */\r\nfunction sendSimpleResult(socket, res: boolean = false): void {\r\n    socket.emit('closer', JSON.stringify({Result: res}));\r\n    socket.disconnect();\r\n}\r\n\r\n/**\r\n * Entry Point of the Socket.io server\r\n * Starts the server and outputs Version and Port\r\n */\r\nserver.listen(config.ServerPort, () => {\r\n    mysqlConnectionManager.insertServerLog(\"\", \"openMPS Server: \"\r\n        + Version + \" Listening on: \" + config.ServerPort);\r\n    console.log('openMPS Server V %s, Listening on %s', Version, config.ServerPort);\r\n});"]}